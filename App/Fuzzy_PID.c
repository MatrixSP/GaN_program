#include <Fuzzy_PID.h>
extern float nDirControlOut,nDirControlOutNew,nDirControlOutOld,GYRO_y ;
extern int Speed_Scan;
extern float SS,AP,SP,QZ,QZo;
float DIRC_P, DIRC_D, DIRC_I;
float DIRC_Po = 180;
float DIRC_Do = 32.5;//35
float DIRC_Io = 0.1;
float Dp = -20;
float Dd = -0.8;
float Di = 2;
float DQZ = 1;
float e_spr = 0.1;
float ec_spr = 1.5;
float e = 0, ec = 0; 
float huanxin_db = 1;
//[ec][es] ¬€”Ú{-3 -2.5 -2 -1.5 -1 -0.5 0 0.5 1 1.5 2 2.5 3}
float P[13][13] = { 0.243768533,	0.206073393,	0.194430188,	0.18489099,	0.176800978,	0.139896491,	0.124933476,	0.116120553,	0.107438666,	0.091241905,	0.059984602,	0.040269757,	-4.41237E-18,	0.206073393,	0.206073393,	0.192750395,	0.158106439,	0.14976346,	0.105821288,	0.096546815,	0.061458724,	0.043125067,	0.033330646,	0.030190394,	0.012743429,	-0.028609041,	0.194430188,	0.192750395,	0.194430184,	0.158106438,	0.135466356,	0.096608037,	0.079949537,	0.049734887,	0.025987716,	0.012222181,	-0.009981567,	-0.010040841,	-0.049966834,	0.18489099,	0.158106439,	0.158106438,	0.126058607,	0.104796034,	0.064817634,	0.049735457,	0.040690705,	0.016427585,	-6.20196E-18,	-0.019224151,	-0.041499902,	-0.065418771,	0.176800978,	0.135084377,	0.135466356,	0.104796034,	0.090880727,	0.052964327,	0.02598835,	0.016427638,	1.00676E-17,	-0.016427585,	-0.025987716,	-0.051575874,	-0.079961685,	0.139896491,	0.096608037,	0.094402172,	0.064817634,	0.052964327,	0.046859419,	0.019224714,	-7.33935E-18,	-0.016427638,	-0.040690705,	-0.049734887,	-0.060053943,	-0.101983083,	0.124933476,	0.096546815,	0.06900413,	0.040921692,	0.02598835,	0.019224714,	0.00998152,	-0.009814981,	-0.02598835,	-0.049735457,	-0.079949537,	-0.096546815,	-0.166607888,	0.091176127,	0.061458724,	0.040921069,	0.025556762,	0.009814446,	-7.33935E-18,	-0.009814981,	-0.025563161,	-0.040983093,	-0.062156208,	-0.096608037,	-0.105821288,	-0.168443413,	0.069017095,	0.043125067,	0.025987716,	0.007574032,	-0.009981566,	-0.01922421,	-0.02598835,	-0.040983093,	-0.069075667,	-0.091849014,	-0.135466356,	-0.14976346,	-0.176800978,	0.052629772,	0.028782161,	0.012628518,	-0.002153577,	-0.019224157,	-0.043810673,	-0.049735457,	-0.062156208,	-0.091849014,	-0.091849181,	-0.132891749,	-0.158106439,	-0.18489099,	0.039983184,	8.22543E-11,	1.20823E-17,	-0.012628518,	-0.025987716,	-0.049734887,	-0.079949537,	-0.096608037,	-0.135466356,	-0.132891749,	-0.135466738,	-0.163272084,	-0.194430188,	0.025166328,	-0.016028538,	-0.033675154,	-0.033847267,	-0.043125067,	-0.061458724,	-0.096546815,	-0.105821288,	-0.14976346,	-0.158106439,	-0.163272084,	-0.163272086,	-0.206073393,	-4.41237E-18,	-0.040269757,	-0.059984602,	-0.091241905,	-0.107438666,	-0.116120553,	-0.124933476,	-0.139896491,	-0.176800978,	-0.18489099,	-0.194430188,	-0.206073393,	-0.243768533 };
float D[13][13] = { 0.999801382,	0.747575044,	0.599846021,	0.499885719,	0.399831926,	0.264333111,	0.000158594,	0.341369297,	0.558168236,	0.754180415,	0.976841234,	1.283716353,	2.437685329,	0.092304713,	0.092304713,	0.092304714,	0.035233811,	-0.065612038,	-0.23677929,	-0.431681536,	-0.118614076,	0.150809056,	0.328030406,	0.510074649,	0.5104653,	1.927503984,	-0.371357468,	-0.367865376,	-0.371369233,	-0.346413138,	-0.371369149,	-0.444543904,	-0.690030895,	-0.213750731,	0.218169709,	0.117865479,	0.065050541,	0.439383772,	1.768011994,	-1.098518853,	-1.098518852,	-1.098518851,	-1.1265674,	-1.023058719,	-0.818635879,	-0.67459399,	-0.27439408,	0.012368455,	0.010541233,	0.09913618,	0.289431086,	1.65716691,	-1.452140996,	-1.43241127,	-1.452140994,	-1.397137719,	-1.321113327,	-0.929217417,	-0.690030895,	-0.287076613,	0.000658989,	0.104510662,	0.260455141,	0.326524089,	1.667065453,	-1.614251477,	-1.564833243,	-1.576863389,	-1.576863371,	-1.32517838,	-0.942461839,	-0.67459399,	-0.287742933,	7.31441E-05,	0.265070962,	0.409276077,	0.600608631,	1.362873225,	-2.436364017,	-1.632243727,	-1.35428715,	-1.328523219,	-1.354286985,	-0.943871636,	-0.690030895,	-0.28781395,	7.3214E-06,	0.265011333,	0.690184824,	0.965651149,	1.249507411,	-1.996601352,	-1.564833243,	-1.325178552,	-1.190831734,	-1.190831594,	-0.942461839,	-0.67459399,	-0.287742933,	7.31441E-05,	0.265070962,	0.674813214,	0.911821495,	1.162736881,	-1.87658808,	-1.43241127,	-1.321113489,	-1.137928874,	-1.057381451,	-0.831209055,	-0.690030895,	-0.287076613,	0.000658989,	0.265630433,	0.69075836,	0.840939632,	1.088473799,	-1.382881086,	-1.165714245,	-1.02305885,	-0.920498615,	-0.962770875,	-0.762451516,	-0.606846287,	-0.27439408,	0.012368455,	0.272390076,	0.614723971,	0.772116329,	1.036471457,	-0.443539972,	-0.439383772,	-0.371369233,	-0.569155612,	-0.677969432,	-0.60562662,	-0.599706,	-0.186895611,	0.218169709,	0.465943044,	0.79997394,	0.953460432,	1.197254627,	0.03907243,	0.017650919,	-0.135559973,	-0.350668579,	-0.420226961,	-0.449718933,	-0.402557104,	-0.088163836,	0.219409264,	0.557172483,	0.992923488,	1.178188332,	1.467794601,	0.999801382,	0.596940904,	0.399831841,	0.116097087,	0.013122445,	0.001491337,	0.000158594,	0.341369297,	0.558168236,	0.754180415,	0.976841234,	1.283716353,	2.437685329 };
float I[13][13] = { -0.048753707,	-0.048517828,	-0.048753707,	-0.040131966,	-0.038885991,	-0.036977574,	-0.035352522,	-0.021164713,	-0.015992337,	-0.013083754,	-0.009993367,	-0.005721808,	4.2134E-19,	-0.041214679,	-0.033824389,	-0.032654417,	-0.031390812,	-0.032654321,	-0.025211303,	-0.021537979,	-0.012755632,	-0.010315175,	-0.00829998,	-0.005249718,	-0.000682643,	0.005033266,	-0.038886038,	-0.032654417,	-0.029744396,	-0.028607478,	-0.027093271,	-0.020958863,	-0.018173132,	-0.010592867,	-0.005197543,	-0.00384483,	-0.001996313,	0.002548686,	0.007996637,	-0.036978198,	-0.031621288,	-0.028607478,	-0.022404955,	-0.020375081,	-0.012963527,	-0.010080833,	-0.00888834,	-0.003844831,	-0.000430715,	0.002444436,	0.005663468,	0.010525954,	-0.035360196,	-0.027016875,	-0.027093271,	-0.020375081,	-0.015999446,	-0.008890895,	-0.005209101,	-0.003856218,	-0.001996313,	0.001514806,	0.005197543,	0.008625013,	0.013803419,	-0.027979298,	-0.019321607,	-0.018880434,	-0.012963527,	-0.008890895,	-0.006457684,	-0.002526966,	-1.21118E-06,	0.001962889,	0.005111352,	0.008184214,	0.012291745,	0.018235225,	-0.024986695,	-0.019309363,	-0.013800826,	-0.008184338,	-0.00519767,	-0.002525692,	2.41058E-18,	0.002525692,	0.00519767,	0.008184338,	0.013800826,	0.019309363,	0.024986695,	-0.018235225,	-0.012291745,	-0.008184214,	-0.005111352,	-0.001962889,	1.21118E-06,	0.002526966,	0.006457684,	0.008890895,	0.012963527,	0.018880434,	0.019321607,	0.027979298,	-0.013803419,	-0.008625013,	-0.005197543,	-0.001514806,	0.001996313,	0.003856218,	0.005209101,	0.008890895,	0.015999446,	0.020375081,	0.027093271,	0.027016875,	0.035360196,	-0.010525954,	-0.005756432,	-0.002525704,	0.000430715,	0.003844831,	0.00888834,	0.010080833,	0.012963527,	0.020375081,	0.022404955,	0.028607478,	0.031621288,	0.036978198,	-0.007996637,	-0.003205708,	2.12415E-18,	0.002525704,	0.005197543,	0.010592867,	0.018173132,	0.020958863,	0.027093271,	0.028607478,	0.029744396,	0.032654417,	0.038886038,	-0.005033266,	3.04657E-18,	0.003205708,	0.005756432,	0.008625013,	0.012963527,	0.021537979,	0.025211303,	0.032654321,	0.031390812,	0.032654417,	0.033824389,	0.041214679,	4.2134E-19,	0.005033266,	0.007996637,	0.010525954,	0.013803419,	0.018880785,	0.027089652,	0.031620887,	0.038885991,	0.040131966,	0.048753707,	0.048517828,	0.048753707 };
void  Fuzzy_Scan(float piancha)
{
  int index_e, index_ec;
  float speed_db,e_db;
  static float piancha_last = 0, piancha_last_last = 0;
  e = piancha * 0.1;
  //ec = piancha - piancha_last;
  ec = 0.07*Get_Gyro(5, 'Y') * 0.02;
  //if (e < 0)
  //{
  //	  ec = -ec;
  //}
  //ec *= ec_spr;
  e *= e_spr;
  e = standard(e);
  //[ec][e] ¬€”Ú{-3 -2.5 -2 -1.5 -1 -0.5 0 0.5 1 1.5 2 2.5 3}
  if (e <= -2.75)
	index_e = 0;
  else if ((e > -2.75) && (e <= -2.25))
	index_e = 1;
  else if ((e > -2.25) && (e <= -1.75))
	index_e = 2;
  else if ((e > -1.75) && (e <= -1.25))
	index_e = 3;
  else if ((e > -1.25) && (e <= -0.75))
	index_e = 4;
  else if ((e > -0.75) && (e <= -0.25))
	index_e = 5;
  else if ((e > -0.25) && (e < 0.25))
	index_e = 6;
  else if ((e >= 0.25) && (e < 0.75))
	index_e = 7;
  else if ((e >= 0.75) && (e < 1.25))
	index_e = 8;
  else if ((e >= 1.25) && (e < 1.75))
	index_e = 9;
  else if ((e >= 1.75) && (e < 2.25))
	index_e = 10;
  else if ((e >= 2.25) && (e < 2.75))
	index_e = 11;
  else if (e >= 2.75)
	index_e = 12;
  
  if (ec <= -2.75)
	index_ec = 0;
  else if ((ec> -2.75) && (ec<= -2.25))
	index_ec = 1;
  else if ((ec> -2.25) && (ec<= -1.75))
	index_ec = 2;
  else if ((ec> -1.75) && (ec<= -1.25))
	index_ec = 3;
  else if ((ec> -1.25) && (ec<= -0.75))
	index_ec = 4;
  else if ((ec> -0.75) && (ec<= -0.25))
	index_ec = 5;
  else if ((ec> -0.25) && (ec< 0.25))
	index_ec = 6;
  else if ((ec>= 0.25) && (ec< 0.75))
	index_ec = 7;
  else if ((ec>= 0.75) && (ec< 1.25))
	index_ec = 8;
  else if ((ec>= 1.25) && (ec< 1.75))
	index_ec = 9;
  else if ((ec>= 1.75) && (ec< 2.25))
	index_ec = 10;
  else if ((ec>= 2.25) && (ec< 2.75))
	index_ec = 11;
  else if (ec>= 2.75)
	index_ec = 12;
  
  //speed_db = Speed_Scan * 0.0001 * Speed_Scan * 0.0001 * 40;
  //speed_db = Speed_Scan * 0.0001 * 5;
  //e_db = e * 0.3 + ec * ec * 0.05;
  //QZ = QZo + (int)(DQZ * (Speed_Scan - 1000) * 0.01);
  DIRC_P = DIRC_Po + Dp * standard(P[index_ec][index_e]);
  DIRC_D = DIRC_Do + Dd * standard(D[index_ec][index_e]);
  DIRC_I = DIRC_Io + Di * I[index_ec][index_e];

//  nDirControlOutOld = nDirControlOutNew;
//  nDirControlOutNew = piancha*DIRC_P - GYRO_y*DIRC_D;
  //	nDirControlOut += DIRC_P * (piancha - piancha_last) + DIRC_I*piancha + DIRC_D*(piancha - 2 * piancha_last + piancha_last_last);
  //	piancha_last_last = piancha_last;
  //	piancha_last = piancha;
  //  speed_db = 1;
  //  if (Speed_Scan <= 1800)
  //  {
  //    SS = 1900;
  //    AP = 1800;
  //    SP = 3.5;
  //  }
  //  else
  //  {
  //    SS = 0;
  //    AP = 1800;
  //    SP = 1;
  //  }
}

float standard(float input)
{
  if (input >= 0)
	return input;
  else
	return -input;
}